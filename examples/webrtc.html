<!DOCTYPE><html><head>

	<title>Xirsys XSDK: WebRTC Example</title>
	<link rel="stylesheet" type="text/css" href="../css/style.css"></link>
	<script src="xirsys_connect.js"></script>
	<script src="../lib/xirsys.core.js"></script>
	<script src="../lib/xirsys.signal.js"></script>
	<script src="../lib/xirsys.api.js"></script>
	<script src="../lib/xirsys.p2p.adapter.js"></script>
	<script src="../lib/xirsys.p2p.js"></script>
	<script>
	
		'use strict'

		window.onload = function () {
		
			// Getting references to page DOM for signalling.
//			var sendMessage = document.getElementById("sendMessage"),
			var	peers = document.getElementById("peers"),
//				message = document.getElementById("message"),
//				messages = document.getElementById("messages"),
				login = document.getElementById("login"),
				username = document.getElementById("username"),
  				usernameLabel = document.getElementById("username-label"),
				name = "";
		
			// Getting references to page DOM for video calling.
			var hangUp = document.getElementById("hang-up"),
				localVideo = document.getElementById("localVideo"),
				remoteVideo = document.getElementById("remoteVideo");
			
			// Settings for video calling.
  			var useAudio = true,
  				useVideo = true,
  				forceTurn = false,
  				automaticAnswer = false;
			
			// Making the Xirsys p2p instance.
			var p = new $xirsys.p2p(
				(xirsysConnect.secureTokenRetrieval === true) ? 
					xirsysConnect.server : null, 
				{
					audio: useAudio, 
					video: useVideo, 
					forceTurn: forceTurn
				}, 
				localVideo, 
				remoteVideo	
			);

			// When the connect button is clicked hide log-in, check the user-
			// name is valid, cancel automatic answers (see xirsys.p2p.js
			// onSignalMessage method) and open a connexion to the server.
			login.onsubmit = function ($event) {
				$event.preventDefault();
				login.style.visibility = 'hidden';
				name = username.value.replace(/\W+/g, "");
				if (!name || name == "") {
					return;
				}
				var connectionProperties = xirsysConnect.data;
				connectionProperties.automaticAnswer = automaticAnswer;
				connectionProperties.username = name;
				p.open(connectionProperties);
			}

			// Add a peer element to the page when a new peer connects.
			var addPeer = function ($peer_name) {
				if (!!document.getElementById("peer_" + $peer_name) || $peer_name == name) {
					while (usernameLabel.hasChildNodes()) {
						usernameLabel.removeChild(usernameLabel.lastChild);
					}
					usernameLabel.appendChild(document.createTextNode(stripLeaf($peer_name)));
					return;
				}
				var node = document.createElement("div"),
					btn = document.createElement("button");
				btn.appendChild(document.createTextNode("connect"));
				node.appendChild(document.createTextNode(stripLeaf($peer_name)));
				node.appendChild(btn);
				peers.appendChild(node);
				node.id = "peer_" + $peer_name;
				node.className = "peer";
				btn.onclick = function () {
					p.call($peer_name);
				}
			};
			
			// Ends current call, if any.
			hangUp.onclick = function () {
				p.hangUp();
			}

			// Removes peer elements from the page when a peer leaves.
			var removePeer = function ($peer_name) {
				var node = document.getElementById("peer_" + $peer_name);
				peers.removeChild(node);
			};

			// Returns a peer name without the room and application details.
			var stripLeaf = function ($p) {
				return $p.substr($p.lastIndexOf("/")+1)
			};

			// When a peer connects to signal server we get notified.
			$xirsys.events.getInstance().on($xirsys.signal.peerConnected, function ($evt, $msg) {
				addPeer($msg);
			});
			
			// When a peer disconnects from the signal server we get notified.
			$xirsys.events.getInstance().on($xirsys.signal.peerRemoved, function ($evt, $msg) {
				removePeer($msg);
			});
			
			// Triggered on login. There may be zero to many peers at this time.
			$xirsys.events.getInstance().on($xirsys.signal.peers, function ($evt, $msg) {
				for (var i = 0; i < $msg.users.length; i++) {
					addPeer($msg.users[i]);
				}
			});
			
			// If you've turned off automatic responses then listen to call
			// offers and allow the user to decide whether to respond or not.
			// Else calls are automatically answered (see xirsys.p2p.js).
			if (automaticAnswer === false) {
				$xirsys.events.getInstance().on($xirsys.p2p.offer, function ($evt, $peer, $data) {
					if (confirm('Take a call from ' + $peer + '?')) {
						p.answer($peer, $data);
					}
				});
			}
			
			// Log errors in the terminal.
			$xirsys.events.getInstance().on($xirsys.signal.error, function ($evt, $msg) {
				console.error("error: ", $msg);
			});
		}

	</script>

</head><body>

	<h1>WebRTC Demo</h1>
	<section>
		<form id="login" class="box">
			Username: <input type="text" id="username" placeholder="enter a username" />
			<button id="login-btn" type="submit">connect</button>
		</form>
		<div class="box">
			Your username: <strong><span id="username-label"></span></strong>
		</div>
		<div id="peers" class="box">
			<h2>Peers</h2>
			<button id="hang-up">Hang up</button><br><br>
		</div>
	</section>
	<section>
		<div id="lVideo" class="video-container box">
			<video autoplay="autoplay" id="localVideo" muted="true"></video>
		</div>
		<div id="rVideo" class="video-container box">
			<video autoplay="autoplay" id="remoteVideo"></video>
		</div>
	</section>

</body></html>

