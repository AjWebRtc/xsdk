<html>
<head>
  <title>Data Channel Test</title>
  <link rel="stylesheet" type="text/css" href="css/style.css"></link>
  <script type="text/javascript" src="xirsys_connect.js"></script>
  <script type="text/javascript" src="lib/xirsys.core.js"></script>
  <script type="text/javascript" src="lib/xirsys.signal.js"></script>
  <script type="text/javascript" src="lib/xirsys.api.js"></script>
  <script type="text/javascript" src="lib/xirsys.p2p.adapter.js"></script>
  <script type="text/javascript" src="lib/xirsys.p2p.js"></script>
  <script type="text/javascript">

    window.onload = function () {
      // Getting references to page DOM.
      var btn = document.getElementById("send"),
          peers = document.getElementById("peers"),
          message = document.getElementById("message"),
          messages = document.getElementById("messages"),
          login = document.getElementById("login"),
          username = document.getElementById("username"),
          name = "",
          peer = "",
          connected = false;

      // When the connect button is clicked...
      login.onclick = function() {
        // Make the username valid.
        var name = username.value.replace(/\W+/g, "");
        if (!name || name == "") return;

        var p = new $xirsys.p2p(
        	(xirsysConnect.secure === true) ? xirsysConnect.server : null, 
      		{audio: false, video: false, dataChannels: ["messageChannel"]}
      	);
       var connectionProperties = xirsysConnect.data;
       connectionProperties.username = name;
        var s = p.open(connectionProperties);

        // Peer connected helper function (UI only).
        var addPeer = function($peer_name) {
          if (!!document.getElementById("peer_" + $peer_name) || $peer_name == name)
            return;
          var node = document.createElement("div"),
              btn = document.createElement("button");
          btn.appendChild(document.createTextNode("connect"));
          node.appendChild(document.createTextNode(stripLeaf($peer_name)));
          node.appendChild(btn);
          peers.appendChild(node);
          node.id = "peer_" + $peer_name;
          node.className = "peer";
          btn.onclick = function() {
            p.call($peer_name);
          }
        };

        // Peer removal helper function (UI only).
        var removePeer = function($peer_name) {
          var node = document.getElementById("peer_" + $peer_name);
          peers.removeChild(node); //Showing an error
        };

        var addMessage = function($msg) {
          var d = document.createElement("div");
          d.appendChild(document.createTextNode($msg));
          messages.appendChild(d);
        };

        var stripLeaf = function(p) {
          return p.substr(p.lastIndexOf("/")+1)
        };

        // When a peer connects to signalling, we
        // get notified here.
        $xirsys.events.getInstance().addListener($xirsys.signal.peerConnected, function($msg) {
          addPeer($msg);
        });
        
        // When a peer leaves (disconnects) from
        // the signalling, we get notified here.
        $xirsys.events.getInstance().addListener($xirsys.signal.peerRemoved, function($msg) {
          removePeer($msg.data);
        });
        
        // We get this when we login. There may be zero
        // to many peers at this time.
        $xirsys.events.getInstance().addListener($xirsys.signal.peers, function($msg) {
          for (var i = 0; i < $msg.users.length; i++)
            addPeer($msg.users[i]);
        });

        // Here, we listen for an offer, so that
        // we can return the call, making it two way.
        $xirsys.events.getInstance().addListener($xirsys.p2p.offer, function($status, $peer) {
          // If we're not calling, then we're answering.
          if ($status != $xirsys.p2p.CALLING &&
              $status != $xirsys.p2p.CONNECTED)
            // So, go ahead and create a call going
            // the other way.
            p.call($peer);
            peer = stripLeaf($peer);
        });

        // Here, we do something when the send button
        // is clicked.
        $xirsys.events.getInstance().addListener($xirsys.p2p.iceConnected, function() {
          if (!connected)
            connected = true;
        });

        $xirsys.events.getInstance().addListener($xirsys.p2p.dataChannelOpen, function() {
          btn.onclick = function() {
            addMessage(name + ": " + message.value);
            p.dataChannelSend(message.value);
          }
        });

        $xirsys.events.getInstance().addListener($xirsys.p2p.dataChannelError, function($err) {
          console.log("datachannel error", $err);
        });

        $xirsys.events.getInstance().addListener($xirsys.p2p.dataChannelMessage, function($msg) {
          addMessage(peer + ": " + $msg);
        });
      }
    }


  </script>
</head>

<body>
  <section>
    <div class="form box">
      <input type="text" id="username" placeholder="enter a username" />
      <button id="login">connect</button>
    </div>
    <div id="peers" class="form box">
      <h1>Peers</h1>
      <div class="peer"></div> 
    </div>
  </section>
  <section>
    <div class="message box">
      <div id="messages"></div>
      <hr />
      message: <input type="text" id="message" />
      <button id="send">Send</button>
    </div>
  </section>
</body>
</html>
