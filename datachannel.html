<!DOCTYPE html><html><head>

	<title>Data Channel Test</title>
	<link rel="stylesheet" type="text/css" href="css/style.css"></link>
	<script src="xirsys_connect.js"></script>
	<script src="lib/xirsys.core.js"></script>
	<script src="lib/xirsys.signal.js"></script>
	<script src="lib/xirsys.api.js"></script>
	<script src="lib/xirsys.p2p.adapter.js"></script>
	<script src="lib/xirsys.p2p.js"></script>
	<script>

		window.onload = function () {
		
			// Getting references to page DOM.
			var sendMessage = document.getElementById("sendMessage"),
				peers = document.getElementById("peers"),
				message = document.getElementById("message"),
				messages = document.getElementById("messages"),
				login = document.getElementById("login"),
				username = document.getElementById("username"),
				name = "",
				peer = "",
				connected = false;

			// When the connect button is clicked...
			login.onsubmit = function ($event) {
				$event.preventDefault();
				// Make the username valid.
				name = username.value.replace(/\W+/g, "");
				if (!name || name == "") {
					return;
				}
			
				var p = new $xirsys.p2p(
					(xirsysConnect.secure === true) ? xirsysConnect.server : null, 
					{audio: false, video: false, dataChannels: ["messageChannel"]}
				);
				
				var connectionProperties = xirsysConnect.data;
				connectionProperties.username = name;
				var s = p.open(connectionProperties);

				// Peer connected helper function (UI only).
				var addPeer = function ($peer_name) {
					if (!!document.getElementById("peer_" + $peer_name) || $peer_name == name) {
						return;
					}
					var node = document.createElement("div"),
						btn = document.createElement("button");
					btn.appendChild(document.createTextNode("connect"));
					node.appendChild(document.createTextNode(stripLeaf($peer_name)));
					node.appendChild(btn);
					peers.appendChild(node);
					node.id = "peer_" + $peer_name;
					node.className = "peer";
					btn.onclick = function () {
						p.call($peer_name);
					}
				};

				// Peer removal helper function (UI only).
				var removePeer = function ($peer_name) {
					var node = document.getElementById("peer_" + $peer_name);
					peers.removeChild(node); //Showing an error
				};

				var addMessage = function ($msg) {
					var d = document.createElement("div");
					d.appendChild(document.createTextNode($msg));
					messages.appendChild(d);
				};

				var stripLeaf = function (p) {
					return p.substr(p.lastIndexOf("/")+1)
				};

				// When a peer connects to signalling, we
				// get notified here.
				$xirsys.events.getInstance().addListener($xirsys.signal.peerConnected, function ($msg) {
					addPeer($msg);
				});
				
				// When a peer leaves (disconnects) from
				// the signalling, we get notified here.
				$xirsys.events.getInstance().addListener($xirsys.signal.peerRemoved, function ($msg) {
					removePeer($msg);
				});
				
				// We get this when we login. There may be zero
				// to many peers at this time.
				$xirsys.events.getInstance().addListener($xirsys.signal.peers, function ($msg) {
					for (var i = 0; i < $msg.users.length; i++)
						addPeer($msg.users[i]);
				});

				// Here, we listen for an offer, so that
				// we can return the call, making it two way.
				$xirsys.events.getInstance().addListener($xirsys.p2p.offer, function ($status, $peer) {
					// If we're not calling, then we're answering.
					if ($status != $xirsys.p2p.CALLING && $status != $xirsys.p2p.CONNECTED) {
						// So, go ahead and create a call going
						// the other way.
						p.call($peer);
					}
					peer = stripLeaf($peer); // Is this functional call expected to happen within or outside of the if statement?
				});

				// Here, we do something when the send button
				// is clicked.
				$xirsys.events.getInstance().addListener($xirsys.p2p.iceConnected, function () {
					if (!connected) {
						connected = true;
					}
				});

				$xirsys.events.getInstance().addListener($xirsys.p2p.dataChannelOpen, function () {
					// Here, we do something when the send button
					// is clicked.
					sendMessage.onsubmit = function ($event) {
						$event.preventDefault();
						addMessage(name + ": " + message.value);
						p.dataChannelSend(message.value);
					}
				});

				$xirsys.events.getInstance().addListener($xirsys.p2p.dataChannelError, function ($err) {
					console.log("datachannel error", $err);
				});

				$xirsys.events.getInstance().addListener($xirsys.p2p.dataChannelMessage, function ($msg) {
					addMessage(peer + ": " + $msg);
				});
			}
		}


	</script>

</head><body>

	<h1>Datachannel Demo</h1>
	<section>
		<form id="login" class="box">
			Username: <input type="text" id="username" placeholder="enter a username" />
			<button type="submit">connect</button>
		</form>
		<div id="peers" class="box">
			<h2>Peers</h2>
			<div class="peer"></div> 
		</div>
	</section>
	<section>
		<div id="messages" class="box"></div>
		<form id="sendMessage" class="message box">
			New message: <input type="text" id="message" />
			<button type="submit">Send</button>
		</form>
	</section>

</body></html>

